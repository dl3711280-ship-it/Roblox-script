local Players = game:GetService("Players")
local UserInputService = game:GetService("UserInputService")
local RunService = game:GetService("RunService")
local LocalPlayer = Players.LocalPlayer
local Camera = workspace.CurrentCamera

local ScreenGui = Instance.new("ScreenGui")
ScreenGui.Parent = LocalPlayer:WaitForChild("PlayerGui")

local ToggleButton = Instance.new("TextButton")
ToggleButton.Parent = ScreenGui
ToggleButton.Position = UDim2.new(0, 10, 0, 10)
ToggleButton.Size = UDim2.new(0, 100, 0, 40)
ToggleButton.Text = "BulletLock: OFF"
ToggleButton.BackgroundColor3 = Color3.fromRGB(0, 170, 0)
ToggleButton.TextColor3 = Color3.fromRGB(255,255,255)

local FOVBox = Instance.new("TextBox")
FOVBox.Parent = ScreenGui
FOVBox.Position = UDim2.new(0, 10, 0, 60)
FOVBox.Size = UDim2.new(0, 100, 0, 30)
FOVBox.PlaceholderText = "FOV"
FOVBox.Text = "60"
FOVBox.BackgroundColor3 = Color3.fromRGB(0, 170, 0)
FOVBox.TextColor3 = Color3.fromRGB(255,255,255)

local enabled = false
local fov = 60

ToggleButton.MouseButton1Click:Connect(function()
    enabled = not enabled
    ToggleButton.Text = enabled and "BulletLock: ON" or "BulletLock: OFF"
end)

FOVBox.FocusLost:Connect(function()
    local n = tonumber(FOVBox.Text)
    if n then fov = n end
end)

local function getClosest()
    local closest,dist = nil,fov
    for _,plr in pairs(Players:GetPlayers()) do
        if plr~=LocalPlayer and plr.Character and plr.Character:FindFirstChild("HumanoidRootPart") and plr.Character:FindFirstChild("Humanoid").Health>0 then
            local pos,_ = Camera:WorldToViewportPoint(plr.Character.HumanoidRootPart.Position)
            if _.Z>0 then
                local mag = (Vector2.new(pos.X,pos.Y)-Vector2.new(Camera.ViewportSize.X/2,Camera.ViewportSize.Y/2)).Magnitude
                if mag<dist then
                    dist=mag
                    closest=plr
                end
            end
        end
    end
    return closest
end

local function shoot()
    local gun = LocalPlayer.Character and LocalPlayer.Character:FindFirstChild("Gun")
    if not gun then return end
    if gun:FindFirstChild("KnifeLocal") and gun.KnifeLocal:FindFirstChild("CreateBeam") then
        local rf = gun.KnifeLocal.CreateBeam:FindFirstChildOfClass("RemoteFunction")
        if rf then
            local target = enabled and getClosest()
            if target then
                rf:InvokeServer(target.Character.HumanoidRootPart.Position)
            else
                rf:InvokeServer()
            end
        end
    end
end

UserInputService.InputBegan:Connect(function(input,gp)
    if gp then return end
    if input.UserInputType==Enum.UserInputType.MouseButton1 or input.KeyCode==Enum.KeyCode.ButtonR2 then
        shoot()
    end
end)
